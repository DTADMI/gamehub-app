name: CI/CD â€” Build, Push (Docker Hub & Artifact Registry), Deploy Cloud Run

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  # Artifact Registry repository name (create it once in your project)
  AR_REPO: ${{ vars.AR_REPO || 'gamehub' }}
  FRONTEND_SERVICE: ${{ vars.FRONTEND_SERVICE || 'gamehub-app' }}

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node & pnpm (Corepack)
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Enable Corepack (pnpm)
        run: |
          corepack enable
          corepack prepare pnpm@10.24.0 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Test
        run: pnpm test

      - name: Build
        run: pnpm build

  build-and-push-dockerhub:
    needs: [ test-frontend ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set env flags for Docker Hub
        id: hubflags
        run: |
          if [ -n "${{ vars.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "has_hub=true" >> $GITHUB_OUTPUT
          else
            echo "has_hub=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' }}
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' }}

      - name: Build Docker image (with public env build args)
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' }}
        run: |
          echo "IMAGE_DOCKERHUB=${{ vars.DOCKERHUB_USERNAME }}/gamehub-app:${{ github.sha }}" >> $GITHUB_ENV
          echo "IMAGE_DOCKERHUB_LATEST=${{ vars.DOCKERHUB_USERNAME }}/gamehub-app:latest }}" >> $GITHUB_ENV

          docker build \
            --build-arg NEXT_PUBLIC_API_URL="${{ vars.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_API_KEY="${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID="${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_APP_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" \
            -t $IMAGE_DOCKERHUB .

          docker build \
            --build-arg NEXT_PUBLIC_API_URL="${{ vars.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_API_KEY="${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID="${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_APP_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" \
            -t $IMAGE_DOCKERHUB_LATEST .

      - name: Push image
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true' && env.IMAGE_DOCKERHUB != '' }}
        run: docker push $IMAGE_DOCKERHUB
      - name: Push image latest
        if: ${{ github.ref == 'refs/heads/main' && steps.hubflags.outputs.has_hub == 'true'&& env.IMAGE_DOCKERHUB_LATEST != '' }}
        run: docker push $IMAGE_DOCKERHUB_LATEST

  build-and-deploy-cloudrun:
    needs: [ test-frontend ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set flags for GCP deploy
        id: gcpflags
        run: |
          HAS_KEY=false
          HAS_WIF=false
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then HAS_KEY=true; fi
          if [ -n "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}" ] && [ -n "${{ secrets.GCP_SERVICE_ACCOUNT }}" ]; then HAS_WIF=true; fi
          if [ -n "${{ secrets.GCP_PROJECT_ID }}" ] && [ -n "${{ secrets.GCP_REGION }}" ] && { [ "$HAS_KEY" = "true" ] || [ "$HAS_WIF" = "true" ]; }; then
            echo "can_deploy=true" >> $GITHUB_OUTPUT
            echo "has_wif=$HAS_WIF" >> $GITHUB_OUTPUT
          else
            echo "can_deploy=false" >> $GITHUB_OUTPUT
            echo "has_wif=false" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud (WIF)
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' && steps.gcpflags.outputs.has_wif == 'true' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Authenticate to Google Cloud (Service Account Key)
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' && steps.gcpflags.outputs.has_wif != 'true' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker to use gcloud as a credential helper
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Compute image tags
        id: tags
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          SHA=${GITHUB_SHA::12}
          echo "frontend=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ vars.FRONTEND_SERVICE }}:${SHA}" >> $GITHUB_OUTPUT

      - name: Build Docker image (with public env build args)
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          AR_REPO=${{ vars.GCP_ARTIFACT_REPO }}
          if [ -z "$AR_REPO" ]; then AR_REPO=gamehub; fi
          IMAGE=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${AR_REPO}/gamehub-app:${{ github.sha }}

          FINGERPRINT=$(printf "%s" "${{ vars.NEXT_PUBLIC_API_URL }}|${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}|${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}|${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}|${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}|${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}|${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" | sha256sum | cut -d' ' -f1)

          docker build \
            --build-arg NEXT_PUBLIC_API_URL="${{ vars.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_API_KEY="${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="${{ vars.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_PROJECT_ID="${{ vars.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="${{ vars.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="${{ vars.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" \
            --build-arg NEXT_PUBLIC_FIREBASE_APP_ID="${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" \
            --build-arg PUBLIC_ENV_FINGERPRINT="$FINGERPRINT" \
            -t $IMAGE .

          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Push image
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: docker push $IMAGE

      - name: Deploy to Cloud Run
        if: ${{ github.ref == 'refs/heads/main' && steps.gcpflags.outputs.can_deploy == 'true' }}
        run: |
          gcloud run deploy gamehub-app \
            --image=$IMAGE \
            --region=${{ secrets.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=3000
